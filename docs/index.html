<!DOCTYPE html>
<html>
  <head>
    <title>ROS 2 Graph Viewer</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <script src="https://unpkg.com/elkjs@0.7.1/lib/elk.bundled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-elk@2.3.0/dist/cytoscape-elk.min.js"></script>

    <script src="https://unpkg.com/cytoscape-svg@0.4.0/cytoscape-svg.js"></script>
    <style>
      #cy {
        height: 80vh;
        display: block;
        border-radius: 5px;
        padding: 5px;
        box-shadow: 0 2px 4px;
        border: 1px solid #ddd;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 2%;
        background-color: #f4f4f9;
      }
      .controls {
        margin-bottom: 20px;
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #details-panel {
        border: 1px solid #ccc;
        background-color: #e9ecef;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        height: 20vh;
        overflow: auto;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        padding: 8px 15px;
        background-color: #1e90ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background-color: #1c7ed6;
      }
      .filter-container {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
      }
      .filter-item {
        border-radius: 4px;
        padding: 5px;
        box-shadow: 0 2px 4px;
        margin: 0 5px;
      }
      .menu-item {
        padding: 5px 10px;
        cursor: pointer;
        font-size: 14px;
      }
      .menu-item:hover {
        background-color: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <h1>ROS 2 Graph Viewer</h1>

    <div class="controls">
      <div id="details-panel">
        ã‚¯ãƒªãƒƒã‚¯ã—ãŸè¦ç´ ï¼ˆãƒãƒ¼ãƒ‰ã€ãƒˆãƒ”ãƒƒã‚¯ã€ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã®è©³ç´°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </div>

      <h3>ã‚°ãƒ©ãƒ• ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š (æ­£è¦è¡¨ç¾)</h3>

      <div class="filter-container">
        <div class="filter-item">
          <p>å«ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³</p>
          <p>
            <input
              type="text"
              id="include-regex-input"
              placeholder="ä¾‹: ^/your-namespace/.*(æ­£è¦è¡¨ç¾)"
              style="width: 250px; padding: 5px; margin-right: 10px"
            />
            <button id="add-include-regex-btn">Add Filter</button>
          </p>

          <div id="include-filter-list" style="margin-top: 10px"></div>
        </div>
        <div class="filter-item">
          <p>é™¤å¤–ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³</p>
          <input
            type="text"
            id="exclude-regex-input"
            placeholder="ä¾‹: ^/your-namespace/.*(æ­£è¦è¡¨ç¾)"
            style="width: 250px; padding: 5px; margin-right: 10px"
          />
          <button id="add-exclude-regex-btn">Add Filter</button>
          <div id="exclude-filter-list" style="margin-top: 10px"></div>
        </div>
      </div>

      <p>Export</p>
      <div class="filter-container">
        <div class="filter-item">
          <button id="export-svg-btn">Export as SVG</button>
        </div>
        <div class="filter-item">
          <button id="export-json-btn">Export as JSON</button>
        </div>
      </div>
    </div>

    <div id="cy"></div>

    <div
      id="context-menu"
      style="
        display: none;
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 5px;
      "
    >
      <div class="menu-item" id="add-include-menu">
        â¡ï¸ ã€Œå«ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«ã“ã®Nodeã‚’è¿½åŠ 
      </div>
      <div
        class="menu-item"
        id="add-exclude-menu"
        style="border-top: 1px solid #eee; padding-top: 5px; margin-top: 5px"
      >
        ğŸš« ã€Œé™¤å¤–ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«ã“ã®Nodeã‚’è¿½åŠ 
      </div>
    </div>

    <script>
          var globalObjects = {
              elements: {'graph_metadata': {'created_at': 1762343120002, 'description': 'Captured ROS 2 network graph using subprocess'}, 'nodes': {'/test/dummy/publisher/pcl_publisher': {'id': 'node_0', 'name': '/test/dummy/publisher/pcl_publisher', 'path': ['test', 'dummy', 'publisher', 'pcl_publisher'], 'type': 'component', 'parameters': [{'name': 'publish_frequency_hz', 'value': '5.0', 'type': 'double'}, {'name': 'qos_overrides./parameter_events.publisher.depth', 'value': '1000', 'type': 'integer'}, {'name': 'qos_overrides./parameter_events.publisher.durability', 'value': 'volatile', 'type': 'string'}, {'name': 'qos_overrides./parameter_events.publisher.history', 'value': 'keep_last', 'type': 'string'}, {'name': 'qos_overrides./parameter_events.publisher.reliability', 'value': 'reliable', 'type': 'string'}, {'name': 'use_sim_time', 'value': 'False', 'type': 'boolean'}]}, '/test/dummy/subscriber/pcl_subscriber': {'id': 'node_1', 'name': '/test/dummy/subscriber/pcl_subscriber', 'path': ['test', 'dummy', 'subscriber', 'pcl_subscriber'], 'type': 'component', 'parameters': [{'name': 'qos_overrides./parameter_events.publisher.depth', 'value': '1000', 'type': 'integer'}, {'name': 'qos_overrides./parameter_events.publisher.durability', 'value': 'volatile', 'type': 'string'}, {'name': 'qos_overrides./parameter_events.publisher.history', 'value': 'keep_last', 'type': 'string'}, {'name': 'qos_overrides./parameter_events.publisher.reliability', 'value': 'reliable', 'type': 'string'}, {'name': 'use_sim_time', 'value': 'False', 'type': 'boolean'}]}}, 'topics': {'/rosout': {'id': '/rosout', 'name': '/rosout', 'type': 'rcl_interfaces/msg/Log', 'message_schema': ['byte DEBUG=10', 'byte INFO=20', 'byte WARN=30', 'byte ERROR=40', 'byte FATAL=50', 'builtin_interfaces/Time stamp', '\tint32 sec', '\tuint32 nanosec', 'uint8 level', 'string name', 'string msg', 'string file', 'string function', 'uint32 line']}, '/test/dummy/pointcloud_topic': {'id': '/test/dummy/pointcloud_topic', 'name': '/test/dummy/pointcloud_topic', 'type': 'sensor_msgs/msg/PointCloud2', 'message_schema': ['std_msgs/Header header', '\tbuiltin_interfaces/Time stamp', '\t\tint32 sec', '\t\tuint32 nanosec', '\tstring frame_id', 'uint32 height', 'uint32 width', 'PointField[] fields', '\tuint8 INT8    = 1', '\tuint8 UINT8   = 2', '\tuint8 INT16   = 3', '\tuint8 UINT16  = 4', '\tuint8 INT32   = 5', '\tuint8 UINT32  = 6', '\tuint8 FLOAT32 = 7', '\tuint8 FLOAT64 = 8', '\tstring name      #', '\tuint32 offset    #', '\tuint8  datatype  #', '\tuint32 count     #', 'bool    is_bigendian # Is this data bigendian?', 'uint32  point_step   # Length of a point in bytes', 'uint32  row_step     # Length of a row in bytes', 'uint8[] data         # Actual point data, size is (row_step*height)', 'bool is_dense        # True if there are no invalid points']}}, 'services': {'/test/dummy/pointcloud_service': {'id': '/test/dummy/pointcloud_service', 'name': '/test/dummy/pointcloud_service', 'type': 'std_srvs/srv/Trigger', 'message_schema': ['---', 'bool success   # indicate successful run of triggered service', 'string message # informational, e.g. for error messages']}}, 'actions': {}, 'connections': [{'type': 'topic', 'source_id': '/test/dummy/publisher/pcl_publisher', 'target_id': '/rosout', 'direction': 'publish'}, {'type': 'topic', 'source_id': '/test/dummy/publisher/pcl_publisher', 'target_id': '/test/dummy/pointcloud_topic', 'direction': 'publish'}, {'type': 'service', 'source_id': '/test/dummy/publisher/pcl_publisher', 'target_id': '/test/dummy/pointcloud_service', 'direction': 'call'}, {'type': 'topic', 'source_id': '/test/dummy/pointcloud_topic', 'target_id': '/test/dummy/subscriber/pcl_subscriber', 'direction': 'subscribe'}, {'type': 'topic', 'source_id': '/test/dummy/subscriber/pcl_subscriber', 'target_id': '/rosout', 'direction': 'publish'}, {'type': 'service', 'source_id': '/test/dummy/pointcloud_service', 'target_id': '/test/dummy/subscriber/pcl_subscriber', 'direction': 'provide'}]},
              cy: null,
              mouse: {
                x: 0,
                y: 0,
              },
              style: [
                      // ã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰ãƒãƒ¼ãƒ‰ï¼ˆRectã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                      {
                          selector: '.ros2_package',
                          style: {
                              'background-color': '#f0f0ff',
                              'border-color': '#999',
                              'border-width': 2,
                              'border-style': 'dashed',
                              'padding': '5px',
                              'text-valign': 'top',
                              'text-halign': 'center',
                              'label': 'data(label)',
                              'font-size': '14px',
                              'color': '#333',
                          }
                      },
                      // ROSãƒãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                      {
                          selector: '.ros2_node',
                          style: {
                              'background-color': '#9999ff',
                              'label': 'data(label)',
                              'text-valign': 'center',
                              'color': '#000000',
                              'shape': 'round-rectangle',
                              'width': 'label',
                              'height': 40,
                              'font-size': '14px',
                              'padding': '5px'
                          }
                      },
                      // ãƒˆãƒ”ãƒƒã‚¯ãƒãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                      {
                          selector: '.ros2_topic',
                          style: {
                              'background-color': '#3CB371',
                              'label': 'data(label)',
                              'text-valign': 'center',
                              'color': '#000000',
                              'shape': 'ellipse',
                              'width': 'label',
                              'font-size': '14px',
                              'height': 30,
                              'padding': '5px'
                          }
                      },
                      // ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                      {
                          selector: '.ros2_service',
                          style: {
                              'background-color': '#c5a039',
                              'label': 'data(label)',
                              'text-valign': 'center',
                              'color': '#000000',
                              'shape': 'ellipse',
                              'width': 'label',
                              'font-size': '14px',
                              'height': 30,
                              'padding': '5px'
                          }
                      },
                      {
                          selector: 'node[label]',
                          style: {
                              'min-width': '60px',
                              'text-wrap': 'wrap',
                              'text-max-width': '80px',
                              'font-size': '14px'
                          }
                      },
                      // ã‚¨ãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« (Topic/Serviceå…±é€šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š)
                      { selector: 'edge',
                        style: {
                            'width': 3,
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'label': 'data(label)',
                            'font-size': '14px',
                            'color': '#000000',
                        }
                      },
                      // ** Topic ã‚¨ãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« **
                      { selector: '.ros2_topic_edge',
                        style: {
                            'line-color': '#3CB371', // ãƒˆãƒ”ãƒƒã‚¯ãƒãƒ¼ãƒ‰ã®è‰²ã¨ä¸€è‡´ (ç·‘)
                            'target-arrow-color': '#3CB371',
                        }
                      },

                      // ** Service ã‚¨ãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« **
                      { selector: '.ros2_service_edge',
                        style: {
                            'line-color': '#c5a039', // ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒ¼ãƒ‰ã®è‰²ã¨ä¸€è‡´ (é»„åœŸè‰²)
                            'target-arrow-color': '#c5a039',
                        }
                      },
                  ],
              include_nodes: [],
              exclude_nodes: [
                  // default ã§é™¤å¤–ã—ã¦ãŠããƒªã‚¹ãƒˆ
                  new RegExp('/rosout'),
                  new RegExp('/diagnostics'),
                  new RegExp('/robot_state_publisher'),
                  new RegExp('/rosbridge_websocket'),
                  new RegExp('/rosbag2_recorder'),
                  new RegExp('/rosapi'),
              ],
              current_filtered_data: null,
          };

          function create_diagram(source) {
              const source_data = source;
              let layoutToUse = (typeof cytoscapeDagre === 'function') ? 'dagre' : 'cose';
              const drowContainer = document.getElementById('cy');
              // åˆæœŸåŒ–
              drowContainer.innerHTML = "";

              const cytoscape_data = {
                  container: drowContainer,
                  elements: [],
                  layout: {
                      name: 'elk',
                      padding: 5,
                      nodeDimensionsIncludeLabels: true,
                      fit: true,
                      animate: false,

                      // Elk/Dagreã®ãƒã‚¤ã‚¨ãƒ³ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                      rankDir: 'TB',
                      minLen: function(edge) { return 1; },
                      // edgeSep: 50,
                      // nodeSep: 50,
                      // rankSep: 50,

                      // Elkå›ºæœ‰ã®å®‰å®šåŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆElkä½¿ç”¨æ™‚ã®ã¿æœ‰åŠ¹ï¼‰
                      elk: {
                          'elk.direction': 'DOWN',
                          // 'elk.spacing.componentComponent': 450,
                          'elk.spacing.componentComponent': 50,
                          // 'elk.spacing.nodeNode': 20,
                          'elk.spacing.nodeNode': 10,
                          // 'elk.padding': '[top=60,left=60,bottom=60,right=60]',
                          'elk.padding': '[top=10,left=10,bottom=10,right=10]',
                          'elk.hierarchyHandling': 'INCLUDE_CHILDREN',
                      }
                  },
                  style: globalObjects.style,
              };
              const nodes = {};
              const connectionMap = {};
              const edges = [];


              const add_node = (id) => {
                  const node = source_data.nodes[id];
                  let parent = undefined;
                  let name = "";
                  const pathlist = node.name.split('/');
                  for (let k = 0; k < pathlist.length; k++) {
                      const path_name = pathlist[k];
                      if (path_name == "") continue;
                      name = name + "/" + path_name;
                      if (!(name in nodes)) {
                          const is_node = (k == pathlist.length -1);
                          // if (is_node == false) continue;
                          const elm = {
                              group: 'nodes',
                              data: {
                                  // id: node.name,
                                  id: is_node? id : name,
                                  // label: is_node? node.name : path_name,
                                  label: path_name,
                                  parent: parent? parent : undefined,
                                  details: is_node? node.parameters : undefined,
                                  ros2_type: is_node? "node" : "group",
                              },
                              classes: is_node? "ros2_node": "ros2_package",
                          };
                          nodes[name] = elm;
                      }
                      parent = name;
                  }
              };

              const add_topic = (id) => {
                  const topic = source_data.topics[id];
                  let parent = undefined;
                  let name = "";
                  const pathlist = topic.name.split('/');
                  for (let k = 0; k < pathlist.length; k++) {
                      const path_name = pathlist[k];
                      if (path_name == "") continue;
                      name = name + "/" + path_name;
                      if (!(name in nodes)) {
                          const is_node = (k == pathlist.length -1);
                          // if (is_node == false) continue;
                          const elm = {
                              group: 'nodes',
                              data: {
                                  id: is_node? id : name,
                                  // label: is_node? topic.name : path_name,
                                  label: path_name,
                                  parent: parent? parent : undefined,
                                  details: is_node? topic.message_schema.map(item => item.replaceAll('\t', '  ')) : undefined,
                                  ros2_type: is_node? "topic" : "group",
                              },
                              classes: is_node? "ros2_topic": "ros2_package",
                          };
                          nodes[name] = elm;
                      }
                      parent = name;
                  }
              };

              const add_service = (id) => {
                  const sevice = source_data.services[id];
                  let parent = undefined;
                  let name = "";
                  const pathlist = sevice.name.split('/');
                  for (let k = 0; k < pathlist.length; k++) {
                      const path_name = pathlist[k];
                      if (path_name == "") continue;
                      name = name + "/" + path_name;
                      if (!(name in nodes)) {
                          const is_node = (k == pathlist.length -1);
                          // if (is_node == false) continue;
                          const elm = {
                              group: 'nodes',
                              data: {
                                  id: is_node? id : name,
                                  // label: is_node? sevice.name : path_name,
                                  label: path_name,
                                  parent: parent? parent : undefined,
                                  details: is_node? sevice.message_schema.map(item => item.replaceAll('\t', '  ')) : undefined,
                                  ros2_type: is_node? "service" : "group",
                              },
                              classes: is_node? "ros2_service": "ros2_package",
                          };
                          nodes[name] = elm;
                      }
                      parent = name;
                  }
              };

              for (let index = 0; index < source_data.connections.length; index++) {
                  const { type, source_id, target_id, direction } = source_data.connections[index];
                  const connData = {
                      from: [],
                      to: [],
                      name: "",
                      type: "",
                  };
                  switch (direction) {
                      case 'publish':
                          if (!source_id in source_data.nodes || !target_id in source_data.topics) continue;
                          connData.from.push(source_id);
                          connData.name = target_id;
                          connData.type = "topic";
                          add_node(source_id);
                          break;
                      case 'subscribe':
                          if (!source_id in source_data.topics || !target_id in source_data.nodes) continue;
                          connData.to.push(target_id);
                          connData.name = source_id;
                          connData.type = "topic";
                          add_node(target_id);
                          break;
                      case 'call':
                          if (!source_id in source_data.nodes || !target_id in source_data.services) continue;
                          connData.from.push(source_id);
                          connData.name = target_id;
                          connData.type = "service";
                          add_node(source_id);
                          break;
                      case 'provide':
                          if (!source_id in source_data.services || !target_id in source_data.nodes) continue;
                          connData.to.push(target_id);
                          connData.name = source_id;
                          connData.type = "service";
                          add_node(target_id);
                          break;
                      default:
                          continue;
                          break;
                  }
                  if (connData.name in connectionMap) {
                      const prevData = connectionMap[connData.name];
                      connectionMap[connData.name] = {
                          from: [...prevData.from, ...connData.from],
                          to: [...prevData.to, ...connData.to],
                          name: prevData.name,
                          type: prevData.type,
                      };
                  } else {
                      connectionMap[connData.name] = connData;
                  }
              }
              const add_edge =(source_id, target_id, name, connType) => {
                  const edgeClass = connType === "topic" ? "ros2_topic_edge" : "ros2_service_edge";
                  edges.push({
                      group: 'edges',
                      data: {
                          id: `e-${edges.length + 1}`,
                          source: source_id,
                          target: target_id,
                          label: name,
                          ros2_type:connType == "topic"? "publish" : "call",
                      },
                      classes: edgeClass,
                  });
              };

              for (const key in connectionMap) {
                  const connection = connectionMap[key];
                  const sourceCount = connection.from.length;
                  const targetCount = connection.to.length;
                  if (sourceCount > 0 && targetCount > 0) {
                      for (let i_s = 0; i_s < sourceCount; i_s++) {
                          const source_id = connection.from[i_s];
                          for (let i_t = 0; i_t < targetCount; i_t++) {
                              const target_id = connection.to[i_t];
                              add_edge(source_id, target_id, connection.name, connection.type);
                          }
                      }
                  } else if (sourceCount <= 0) {
                      const source_id = connection.name;
                      connection.type == "topic"? add_topic(source_id) : add_service(source_id);
                      for (let i_t = 0; i_t < targetCount; i_t++) {
                          const target_id = connection.to[i_t];
                          add_edge(source_id, target_id, connection.name, connection.type);
                      }
                  } else {
                      const target_id = connection.name;
                      connection.type == "topic"? add_topic(target_id) : add_service(target_id);
                      for (let i_s = 0; i_s < sourceCount; i_s++) {
                          const source_id = connection.from[i_s];
                          add_edge(source_id, target_id, connection.name, connection.type);
                      }
                  }
              }

              // topic ã§ node ã¨åŒåã®ã‚‚ã®ã¯ãã®parant ã®Group ã«å±ã•ã›ã‚‹
              const rosNodes = [];
              const rosTopics = [];
              const rosServices= [];

              for (const key in nodes) {
                  const element = nodes[key];
                  switch (element.data.ros2_type) {
                      case 'node':
                          rosNodes.push(element);
                          break;
                      case 'topic':
                          rosTopics.push(element);
                          break;
                      case 'service':
                          rosServices.push(element);
                          break;
                      default:
                          break;
                  }
              }

              rosTopics.forEach(topic => {
                  const parent_id = topic.data.parent;
                  const parent_node = rosNodes.find(node => node.data.id == parent_id );
                  if (parent_node) {
                      console.table([{
                          parent_id: parent_id,
                          node_id: parent_node.data.id,
                          node_type: parent_node.data.ros2_type,
                          node_parent: parent_node.data.parent,
                      }]);
                      topic.data.parent = parent_node.data.parent;
                  }
              });


              const node_elements = Object.keys(nodes).map(key => nodes[key]);
              cytoscape_data.elements = [...node_elements, ...edges];
              globalObjects.cy = cytoscape(cytoscape_data);
              // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ€§ã®å®Ÿè£… (ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯)

              globalObjects.cy.on('tap', 'node', function(evt){
                  let element = evt.target;
                  let data = element.data();

                  let typeLabel = '';
                  if (data.ros2_type === 'node') {
                      typeLabel = 'ROSãƒãƒ¼ãƒ‰';
                  } else if (data.ros2_type === 'topic') {
                      typeLabel = 'ãƒˆãƒ”ãƒƒã‚¯';
                  } else if (data.ros2_type === 'package') {
                      typeLabel = 'ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸/ã‚°ãƒ«ãƒ¼ãƒ— (Rect)';
                  } else {
                      typeLabel = 'è¦ç´ ';
                  }

                  let details = data.details ? JSON.stringify(data.details, null, 2) :
                                  `ID: ${data.id}\nROS2 Type: ${data.ros2_type}\n(è©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—)`;

                  let output = `--- [${typeLabel}: ${data.label}] ---\nID: ${data.id}\n--------------------\n${details}`;

                  document.getElementById('details-panel').textContent = output;
              });

              const contextMenu = document.getElementById('context-menu');
              let currentSelectedNodeId = null; // å³ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã®IDã‚’ä¿æŒ

              // 1. ãƒãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹å³ã‚¯ãƒªãƒƒã‚¯ (cxttap) ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
              globalObjects.cy.on('cxttap', 'node', function(evt) {
                  evt.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æŠ‘åˆ¶
                  const node = evt.target;
                  const nodeId = node.data('id');
                  const nodeLabel = node.data('label'); // ãƒ‘ã‚¹å…¨ä½“ã§ã¯ãªãã€æœ€å¾Œã®ãƒ©ãƒ™ãƒ«åãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€IDï¼ˆãƒ•ãƒ«ãƒ‘ã‚¹ï¼‰ã‚’ä½¿ç”¨

                  // ID (ãƒ•ãƒ«ãƒ‘ã‚¹) ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ¼ãƒ‰ã¯ç„¡è¦–
                  if (!nodeId || node.data('ros2_type') === 'group') {
                      contextMenu.style.display = 'none';
                      return;
                  }

                  currentSelectedNodeId = nodeId;

                  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã«è¡¨ç¤ºã™ã‚‹ãƒãƒ¼ãƒ‰åã‚’ä¸€æ™‚çš„ã«è¨­å®š
                  document.getElementById('add-include-menu').textContent = `â¡ï¸ã€Œå«ã‚ã‚‹ã€ã« ${nodeLabel} ã‚’è¿½åŠ `;
                  document.getElementById('add-exclude-menu').textContent = `ğŸš« ã€Œé™¤å¤–ã™ã‚‹ã€ã« ${nodeLabel} ã‚’è¿½åŠ `;

                  contextMenu.style.left = `${globalObjects.mouse.x}px`;
                  contextMenu.style.top = `${globalObjects.mouse.y}px`;
                  contextMenu.style.display = 'block';
              });

              // 2. ã‚°ãƒ©ãƒ•ä¸Šã®ä½•ã‚‚ãªã„å ´æ‰€ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«
              globalObjects.cy.on('cxttap', function(evt) {
                  if (evt.target === globalObjects.cy) {
                      contextMenu.style.display = 'none';
                  }
              });

              // 3. ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†

              // ã€Œå«ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«è¿½åŠ 
              document.getElementById('add-include-menu').addEventListener('click', function() {
                  if (currentSelectedNodeId) {
                      // Node IDã‚’æ­£è¦è¡¨ç¾ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã€å…¨ä½“ãƒãƒƒãƒã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆ
                      // Node ID (e.g., /my_robot/sensor_node) ã‚’ãã®ã¾ã¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦è¿½åŠ 
                      const pattern = currentSelectedNodeId;

                      try {
                          const newRegex = new RegExp(pattern);
                          globalObjects.include_nodes.push(newRegex);
                          renderIncludeFilterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                          redraw_graph(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
                      } catch (e) {
                          alert(`ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªæ­£è¦è¡¨ç¾ã§ã™ ${e.message}`);
                      }
                  }
                  contextMenu.style.display = 'none';
              });

              // ã€Œé™¤å¤–ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«è¿½åŠ 
              document.getElementById('add-exclude-menu').addEventListener('click', function() {
                  if (currentSelectedNodeId) {
                      const pattern = currentSelectedNodeId;

                      try {
                          const newRegex = new RegExp(pattern);
                          globalObjects.exclude_nodes.push(newRegex);
                          renderExcludeFilterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                          redraw_graph(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
                      } catch (e) {
                          alert(`ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªæ­£è¦è¡¨ç¾ã§ã™ ${e.message}`);
                      }
                  }
                  contextMenu.style.display = 'none';
              });

              // 4. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå·¦ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«
              document.addEventListener('click', function(e) {
                  // ã‚¯ãƒªãƒƒã‚¯ãŒãƒ¡ãƒ‹ãƒ¥ãƒ¼è‡ªä½“ã§ãªã‘ã‚Œã°éè¡¨ç¤ºã«ã™ã‚‹
                  if (!contextMenu.contains(e.target) && e.button === 0) {
                      contextMenu.style.display = 'none';
                  }
              });

          }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‰Šé™¤
      function removeIncludeRegex(index) {
      		globalObjects.include_nodes.splice(index, 1);
      		renderIncludeFilterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
      		redraw_graph(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
      }

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚¹ãƒˆã®æç”»
          function renderIncludeFilterList() {
              const includeFilterList = document.getElementById('include-filter-list');
              includeFilterList.innerHTML = '';
              globalObjects.include_nodes.forEach((regex, index) => {
                  const regexText = regex.source; // RegExpã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æ–‡å­—åˆ—ã‚’å–å¾—
                  const patternDiv = document.createElement('span');
                  patternDiv.style.cssText = 'display: inline-block; margin-right: 10px; padding: 5px; border: 1px solid #ccc; background-color: #e6e6e6; border-radius: 4px;';
                  patternDiv.innerHTML = `
                      ${regexText}
                      <button data-index="${index}" class="remove-include-regex-btn" style="margin-left: 5px; background-color: #dc3545; padding: 3px 6px;">x</button>
                  `;
                  includeFilterList.appendChild(patternDiv);
              });

              // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
              document.querySelectorAll('.remove-include-regex-btn').forEach(button => {
                  button.addEventListener('click', function() {
                      const index = parseInt(this.getAttribute('data-index'));
                      removeIncludeRegex(index);
                  });
              });
          }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‰Šé™¤
      function removeExcludeRegex(index) {
      		globalObjects.exclude_nodes.splice(index, 1);
      		renderExcludeFilterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
      		redraw_graph(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
      }


          // ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚¹ãƒˆã®æç”»
          function renderExcludeFilterList() {
              const excludeFilterList = document.getElementById('exclude-filter-list');
              excludeFilterList.innerHTML = '';
              globalObjects.exclude_nodes.forEach((regex, index) => {
                  const regexText = regex.source; // RegExpã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æ–‡å­—åˆ—ã‚’å–å¾—
                  const patternDiv = document.createElement('span');
                  patternDiv.style.cssText = 'display: inline-block; margin-right: 10px; padding: 5px; border: 1px solid #ccc; background-color: #e6e6e6; border-radius: 4px;';
                  patternDiv.innerHTML = `
                      ${regexText}
                      <button data-index="${index}" class="remove-exclude-regex-btn" style="margin-left: 5px; background-color: #dc3545; padding: 3px 6px;">x</button>
                  `;
                  excludeFilterList.appendChild(patternDiv);
              });

              // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
              document.querySelectorAll('.remove-exclude-regex-btn').forEach(button => {
                  button.addEventListener('click', function() {
                      const index = parseInt(this.getAttribute('data-index'));
                      removeExcludeRegex(index);
                  });
              });
          }

          function redraw_graph() {
              // æ—¢å­˜ã®è¦ç´ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
              const all_elements = globalObjects.elements;

              // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®è¦ç´ ã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
              const filtered_elements = {
                  nodes: {...all_elements.nodes},
                  topics: {...all_elements.topics},
                  services: {...all_elements.services},
                  connections: [],
              };

              const include_nodes = globalObjects.include_nodes;
              const exclude_nodes = globalObjects.exclude_nodes;

              // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
              for (let i = 0; i < all_elements.connections.length; i++) {
                  const connection = all_elements.connections[i];
                  let isMatch = false; // æ¥ç¶šã®ã„ãšã‚Œã‹ã®ç«¯ãŒä¸€è‡´ã™ã‚Œã°OKã¨ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯

                  // include_nodes_regex ãŒç©ºã®å ´åˆã¯ã€å…¨ã¦è¡¨ç¤º
                  if (include_nodes.length === 0) {
                      isMatch = true;
                  } else {
                      // æ­£è¦è¡¨ç¾ã®ã„ãšã‚Œã‹ã«ãƒãƒƒãƒã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                      for (let j = 0; j < include_nodes.length; j++) {
                          const regex = include_nodes[j];
                          // source_id ã¾ãŸã¯ target_id ã®ã©ã¡ã‚‰ã‹ãŒãƒãƒƒãƒã™ã‚Œã°è¡¨ç¤º
                          if (connection.source_id.match(regex) || connection.target_id.match(regex)) {
                              isMatch = true;
                              break;
                          }
                      }
                  }

                  for (let j = 0; j < exclude_nodes.length; j++) {
                      const regex = exclude_nodes[j];
                      // source_id ã¾ãŸã¯ target_id ã®ã©ã¡ã‚‰ã‹ãŒãƒãƒƒãƒã™ã‚Œã°éè¡¨ç¤º
                      if (connection.source_id.match(regex) || connection.target_id.match(regex)) {
                          isMatch = false;
                          break;
                      }
                  }
                  if (isMatch) {
                      filtered_elements.connections.push(connection);
                  }
              }

              globalObjects.current_filtered_data = filtered_elements;
              // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ã‚°ãƒ©ãƒ•ã‚’æç”»
              create_diagram(filtered_elements);
          }

          document.addEventListener('DOMContentLoaded', function() {

      	if (typeof cytoscape.use === 'function' && typeof cytoscapeDagre === 'function') {
      			cytoscape.use(cytoscapeDagre);
      			console.log("Dagre layout successfully registered.");
      	} else {
      			console.error("Failed to register Dagre. Falling back to default 'cose'.");
      	}

      	// SVGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ‹¡å¼µã‚’ç™»éŒ²
      	if (typeof cytoscape.use === 'function' && typeof cytoscapeSvg === 'function') {
      			cytoscape.use(cytoscapeSvg);
      			console.log("SVG extension successfully registered.");
      	} else {
      			console.error("Failed to register SVG extension. SVG export functionality may be unavailable.");
      	}

      	redraw_graph();
        const body = document.body;
        body.addEventListener("mousemove", function (event) {
            // 1. è¦ç´ ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆåŸºæº–ã®ä½ç½®ã‚’å–å¾—
            const rect = body.getBoundingClientRect();
            // 2. ãƒã‚¦ã‚¹ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆåŸºæº–ã®ä½ç½®ã‚’å–å¾—
            const clientX = event.clientX;
            const clientY = event.clientY;
            // 3. è¦ç´ å†…ã§ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—,ä¿æŒ
            globalObjects.mouse.x = clientX - rect.left;
            globalObjects.mouse.y = clientY - rect.top;
        });

      	document.getElementById('export-svg-btn').addEventListener('click', function() {

      			if (typeof globalObjects.cy.svg !== 'function') {
      					alert('ã‚¨ãƒ©ãƒ¼: SVGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      					return;
      			}

      			let svg = globalObjects.cy.svg({ scale: 1.5, full: true });

      			let blob = new Blob([svg], { type: 'image/svg+xml' });
      			let url = URL.createObjectURL(blob);

      			let a = document.createElement('a');
      			a.href = url;
      			a.download = 'ros2_graph_diagram.svg';
      			document.body.appendChild(a);
      			a.click();

      			document.body.removeChild(a);
      			URL.revokeObjectURL(url);

      			setTimeout(() => {
      					alert('ros2_graph_diagram.svgã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚');
      			}, 100);
      	});

      	document.getElementById('export-json-btn').addEventListener('click', function() {
      		const data = globalObjects.current_filtered_data;

      		if (!data) {
      				alert('ã‚¨ãƒ©ãƒ¼: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚°ãƒ©ãƒ•ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      				return;
      		}

      		// JSONæ–‡å­—åˆ—ã«æ•´å½¢ã—ã¦å¤‰æ›
      		const jsonString = JSON.stringify(data, null, 2);

      		// ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      		const blob = new Blob([jsonString], { type: 'application/json' });
      		const url = URL.createObjectURL(blob);

      		const a = document.createElement('a');
      		a.href = url;
      		a.download = 'ros2_filtered_graph_data.json';
      		document.body.appendChild(a);
      		a.click();

      		document.body.removeChild(a);
      		URL.revokeObjectURL(url);

      		setTimeout(() => {
      				alert('ros2_filtered_graph_data.jsonã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚');
      		}, 100);
      	});

      	window.addEventListener("resize", function () {
      			if (globalObjects.cy) {
      					globalObjects.cy.resize();
      			}
      	});

      	// include filter ------------------------------------------------------------------------
      	const includeRegexInput = document.getElementById('include-regex-input');
      	const addIncludePatternBtn = document.getElementById('add-include-regex-btn');


      	// ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ 
      	addIncludePatternBtn.addEventListener('click', function() {
      			const pattern = includeRegexInput.value.trim();
      			if (pattern) {
      					try {
      							// æ­£è¦è¡¨ç¾ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦é…åˆ—ã«è¿½åŠ 
      							const newRegex = new RegExp(pattern);
      							globalObjects.include_nodes.push(newRegex);
      							includeRegexInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      							renderIncludeFilterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
      							redraw_graph(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
      					} catch (e) {
      							alert(`ç„¡åŠ¹ãªæ­£è¦è¡¨ç¾ã§ã™: ${e.message}`);
      					}
      			}
      	});

      	// exclude filter ------------------------------------------------------------------------
      	const excludeRegexInput = document.getElementById('exclude-regex-input');
      	const addExcludePatternBtn = document.getElementById('add-exclude-regex-btn');


      	// ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ 
      	addExcludePatternBtn.addEventListener('click', function() {
      			const pattern = excludeRegexInput.value.trim();
      			if (pattern) {
      					try {
      							// æ­£è¦è¡¨ç¾ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦é…åˆ—ã«è¿½åŠ 
      							const newRegex = new RegExp(pattern);
      							globalObjects.exclude_nodes.push(newRegex);
      							excludeRegexInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      							renderExcludeFilterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
      							redraw_graph(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
      					} catch (e) {
      							alert(`ç„¡åŠ¹ãªæ­£è¦è¡¨ç¾ã§ã™: ${e.message}`);
      					}
      			}
      	});

      	// åˆæœŸãƒªã‚¹ãƒˆæç”»
      	renderExcludeFilterList();

          });
    </script>
  </body>
</html>